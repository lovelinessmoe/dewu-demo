# 发票管理页面使用指南

## 概述

发票管理页面是一个完整的 Web 界面，用于管理和处理发票申请。它提供了直观的表格视图和编辑功能。

## 功能特性

### 📊 发票列表
- 显示所有发票的详细信息
- 支持状态筛选和实时刷新
- 响应式表格设计，适配各种屏幕尺寸

### ✏️ 发票编辑
- 点击"编辑"按钮打开模态框
- 可修改发票抬头、公司信息、税号等
- 可更改发票状态
- 本地实时更新（内存中生效）

### ⚡ 发票处理
- **批准**：一键批准待处理发票
- **拒绝**：一键拒绝发票并设置拒绝原因
- 操作后自动刷新列表

### 🔄 实时数据
- 使用统一的核心业务逻辑
- 与 API 测试页面数据同步
- 支持 Supabase 和 fallback 数据

## 使用步骤

### 1. 获取访问令牌
```bash
# 方法一：使用测试页面
访问 http://localhost:3000/test 获取令牌

# 方法二：使用 curl 命令
curl -X POST http://localhost:3000/api/v1/h5/passport/v1/oauth2/token \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": "test_client_id_12345",
    "client_secret": "test_client_secret_abcdefghijklmnop", 
    "authorization_code": "test_auth_code_123456789"
  }'
```

### 2. 访问管理页面
- 打开 http://localhost:3000/manage
- 系统会自动使用测试页面获取的令牌
- 如果没有令牌，页面会提示先获取

### 3. 管理发票数据

#### 查看发票列表
- 页面加载后自动显示所有发票
- 表格包含：订单号、商品、发票抬头、金额、状态、申请时间
- 点击"刷新"按钮重新加载数据

#### 编辑发票信息
1. 点击发票行的"编辑"按钮
2. 在弹出的模态框中修改信息：
   - 发票抬头
   - 公司地址
   - 公司电话
   - 税号
   - 银行名称
   - 银行账号
   - 发票状态
3. 点击"保存"确认修改

#### 处理发票申请
- **批准发票**：点击"批准"按钮，发票状态变为"审核通过"
- **拒绝发票**：点击"拒绝"按钮，发票状态变为"卖家已驳回"
- 只有"待处理"状态的发票才显示处理按钮

## 状态说明

| 状态码 | 状态名称 | 颜色标识 | 说明 |
|--------|----------|----------|------|
| 0 | 待处理 | 黄色 | 新提交的发票申请 |
| 2 | 审核通过 | 绿色 | 已批准的发票 |
| 3 | 已驳回 | 红色 | 系统驳回的发票 |
| 5 | 卖家已驳回 | 红色 | 卖家拒绝的发票 |

## 技术实现

### 前端技术栈
- **React 18** + **TypeScript**
- **Tailwind CSS** 样式框架
- **React Router** 路由管理
- **Axios** HTTP 客户端

### 后端集成
- 使用统一的核心业务逻辑 (`src/shared/core/index.js`)
- 支持 Supabase 数据库和 fallback 数据
- 与 standalone API 和开发服务器完全兼容

### 数据流
```
用户操作 → React 组件 → Invoice Service → API Client → 统一核心逻辑 → 数据存储
```

## API 端点

管理页面使用以下 API 端点：

### 获取发票列表
```http
POST /dop/api/v1/invoice/list
Content-Type: application/json

{
  "access_token": "your_token",
  "page_no": 1,
  "page_size": 100
}
```

### 处理发票
```http
POST /dop/api/v1/invoice/handle
Content-Type: application/json

{
  "access_token": "your_token",
  "order_no": "11001232435",
  "operation_type": 1,  // 1=批准, 2=拒绝
  "category_type": 1,   // 1=电子发票, 2=纸质发票
  "image_key": "approval_key"  // 批准时必需
}
```

## 开发和部署

### 本地开发
```bash
npm run dev
# 访问 http://localhost:3000/manage
```

### 生产构建
```bash
npm run build
# 构建后的文件在 dist/ 目录
```

### Vercel 部署
- 自动使用统一的核心逻辑
- 支持 serverless 函数
- 前后端一体化部署

## 注意事项

1. **令牌管理**：令牌存储在浏览器内存中，刷新页面需要重新获取
2. **数据持久化**：当前使用内存存储，重启服务器会重置数据
3. **权限控制**：当前为演示版本，没有用户权限验证
4. **错误处理**：网络错误和 API 错误都有相应的提示信息

## 扩展功能

可以考虑添加的功能：
- 批量操作（批量批准/拒绝）
- 高级筛选和搜索
- 发票统计图表
- 导出功能（Excel/PDF）
- 用户权限管理
- 操作日志记录

## 故障排除

### 常见问题

1. **页面显示"请先获取访问令牌"**
   - 解决：访问 /test 页面获取令牌

2. **发票列表加载失败**
   - 检查后端服务是否启动
   - 检查网络连接
   - 查看浏览器控制台错误信息

3. **编辑保存后数据没有更新**
   - 当前为本地更新，刷新页面会重置
   - 如需持久化，请配置 Supabase 数据库

4. **处理发票操作失败**
   - 检查发票状态是否为"待处理"
   - 确认访问令牌是否有效
   - 查看网络请求响应

### 调试技巧

1. **查看网络请求**：
   - 打开浏览器开发者工具
   - 切换到 Network 标签
   - 查看 API 请求和响应

2. **查看控制台日志**：
   - 打开 Console 标签
   - 查看错误信息和调试日志

3. **检查后端日志**：
   - 查看终端中的服务器日志
   - 关注 API 请求处理过程

## 总结

发票管理页面提供了完整的发票数据管理功能，采用现代化的 Web 技术栈，与后端 API 无缝集成。通过直观的界面设计，用户可以轻松地查看、编辑和处理发票申请，大大提高了工作效率。